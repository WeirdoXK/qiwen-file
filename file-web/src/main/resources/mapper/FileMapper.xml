<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qiwenshare.file.dao.mapper.FileMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.qiwenshare.file.dao.entity.File">
        <id column="fileId" property="fileId"/>
        <result column="extendName" property="extendName"/>
        <result column="fileName" property="fileName"/>
        <result column="filePath" property="filePath"/>
        <result column="fileSize" property="fileSize"/>
        <result column="fileUrl" property="fileUrl"/>
        <result column="isDir" property="isDir"/>
        <result column="isOSS" property="isOSS"/>
        <result column="timeStampName" property="timeStampName"/>
        <result column="uploadTime" property="uploadTime"/>
        <result column="userId" property="userId"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        fileId, extendName, fileName, filePath, fileSize, fileUrl, isDir, isOSS, timeStampName, uploadTime, userId
    </sql>

    <insert id="saveBatch" parameterType="java.util.List">
        INSERT ignore INTO file (fileId, extendName, fileName, filePath, fileSize, fileUrl, isDir, isOSS, timeStampName,
        uploadTime, userId)
        VALUES
        <foreach collection="fileList" item="file" index="index" separator=",">
            (#{file.fileId}, #{file.extendName},#{file.fileName},
            #{file.filePath}, #{file.fileSize}, #{file.fileUrl}, #{file.isDir},
            #{file.isOSS}, #{file.timeStampName}, #{file.uploadTime}, #{file.userId})
        </foreach>
    </insert>

    <update id="updateFile" parameterType="com.qiwenshare.file.dao.entity.File">
        <choose>
            <when test="isDir == 1">
                UPDATE file SET filename=#{fileName}, uploadTime = #{uploadTime}
                where fileId = #{fileId};
                UPDATE file SET filepath=REPLACE(filepath, #{oldFilePath}, #{filePath}) WHERE filepath LIKE
                N'${oldFilePath}%';
            </when>
            <otherwise>
                update file
                <set>
                    <if test="fileName != null">
                        fileName = #{fileName},
                    </if>
                    <if test="uploadTime != null">
                        uploadTime = #{uploadTime},
                    </if>
                    <if test="fileUrl != null">
                        fileUrl = #{fileUrl},
                    </if>
                </set>
                where fileId = #{fileId}
            </otherwise>
        </choose>

    </update>

    <update id="editFilepathByPathAndName">
        update file set filePath = #{oldFilePath}
        where filePath = #{newFilePath} and fileName = #{fileName}
        <if test="param4 != null">
            and extendName = #{extendName}
        </if>
        <if test="param4 == null">
            and extendName is null
        </if>
    </update>
</mapper>
